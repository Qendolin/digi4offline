"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.RangeDownloader=void 0;var _sanitize=require("./sanitize.js"),_xmldom=require("xmldom"),_tinyAsyncPool=_interopRequireDefault(require("tiny-async-pool"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}class RangeDownloader{constructor(a,b){_defineProperty(this,"poolSize",void 0),_defineProperty(this,"book",void 0),_defineProperty(this,"parser",new _xmldom.DOMParser),_defineProperty(this,"serializer",new _xmldom.XMLSerializer),this.poolSize=a,this.book=b}async download(a,b){let c;const d=new Promise(function(a){c=a});let e=1;return(0,_tinyAsyncPool.default)(this.poolSize,[...a.entries()],async([f,g])=>{0!==f&&(await d);const h=await this._downloadPage(g);0===f&&c(),b(h,{pageCount:a.length,pageIndex:f,pageNr:g,downloadNr:e++})})}async _downloadPage(a){const b=await this.book.page(a);if(null!=b){const c=this.parser.parseFromString(b,"image/svg+xml");if(null==c)return void console.error(b);(0,_sanitize.sanitizeSvg)(c);const d=await this._downloadImages(c,a);return{svg:Buffer.from(this.serializer.serializeToString(c),"utf8"),images:d}}}async _downloadImages(a,b){const c=[],d=new Map;let e=0;const f=Array.from(a.documentElement.getElementsByTagName("image"));return await(0,_tinyAsyncPool.default)(2,f,async a=>{const{link:f,data:g}=await this._downloadImage(b,a);return g?void(c.push(g),d.set(f,{start:e,end:e+g.length}),e+=g.length):void console.warn("Failed to download image %s on page %s",f,b)}),{buffer:Buffer.concat(c,e),map:d}}async _downloadImage(a,b){const c=b.hasAttribute("xlink:href")?"xlink:href":"href",d=b.getAttribute(c);return{link:d,data:await this.book.image(a,d)}}}exports.RangeDownloader=RangeDownloader;