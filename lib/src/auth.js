"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.User=exports.Cookies=void 0;var _xmldom=require("xmldom"),_nodeFetch=_interopRequireDefault(require("node-fetch")),_book=require("./book.js"),_util=require("./util.js");function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _classPrivateFieldSet(a,b,c){var d=_classExtractFieldDescriptor(a,b,"set");return _classApplyDescriptorSet(a,d,c),c}function _classApplyDescriptorSet(a,b,c){if(b.set)b.set.call(a,c);else{if(!b.writable)throw new TypeError("attempted to set read only private field");b.value=c}}function _classPrivateFieldGet(a,b){var c=_classExtractFieldDescriptor(a,b,"get");return _classApplyDescriptorGet(a,c)}function _classExtractFieldDescriptor(a,b,c){if(!b.has(a))throw new TypeError("attempted to "+c+" private field on non-instance");return b.get(a)}function _classApplyDescriptorGet(a,b){return b.get?b.get.call(a):b.value}var _cookies=new WeakMap;class Cookies{constructor(){_cookies.set(this,{writable:!0,value:new Map})}static parse(a){const b=new Cookies;return a=a.replace(/^Cookie: /gi,""),b.set(...a.split("; ")),b}set(...a){a.forEach(a=>{const[b,c]=a.split(";",1)[0].split("=",2);_classPrivateFieldGet(this,_cookies).set(b,c)})}delete(a){const[b]=a.split(";",1)[0].split("=",2);_classPrivateFieldGet(this,_cookies).delete(b)}toString(){return[..._classPrivateFieldGet(this,_cookies).entries()].map(a=>`${a[0]}=${a[1]}`).join("; ")}}exports.Cookies=Cookies;var _cookies2=new WeakMap,_authenticated=new WeakMap,_domParser=new WeakMap;class User{constructor(){_cookies2.set(this,{writable:!0,value:void 0}),_authenticated.set(this,{writable:!0,value:!1}),_domParser.set(this,{writable:!0,value:new _xmldom.DOMParser})}async _findBookInShelf(a){const b=await(0,_nodeFetch.default)(`https://digi4school.at/br/find/${a}/`,{headers:{cookie:_classPrivateFieldGet(this,_cookies2).toString()}}).then(a=>{if(200!=a.status)throw new _util.ResponseError("failed to find book in bookshelf",a);return a.text()});return this._parseLtiResponse(b)}_parseLtiResponse(a){const b=_classPrivateFieldGet(this,_domParser).parseFromString(a,"text/html"),c=b.getElementsByTagName("form")[0],d=new URLSearchParams;return Array.from(c.getElementsByTagName("input")).forEach(a=>{d.set(a.getAttribute("name"),a.getAttribute("value"))}),d}async _ltiShelf(a){const b=await(0,_nodeFetch.default)("https://kat.digi4school.at/lti",{method:"POST",body:a.toString(),headers:{accept:"*/*","accept-language":"*",cookie:_classPrivateFieldGet(this,_cookies2).toString(),"content-type":"application/x-www-form-urlencoded"},redirect:"manual"}).then(a=>{if(200!=a.status)throw new _util.ResponseError("lti failed",a);return _classPrivateFieldGet(this,_cookies2).set(...a.headers.raw()["set-cookie"]),a.text()});return this._parseLtiResponse(b)}async _ltiCatalog(a){return(0,_nodeFetch.default)("https://a.digi4school.at/lti",{method:"POST",body:a.toString(),headers:{accept:"*/*","accept-language":"*",cookie:_classPrivateFieldGet(this,_cookies2).toString(),"content-type":"application/x-www-form-urlencoded"},redirect:"manual"}).then(a=>{if(302!=a.status)throw new _util.ResponseError("lti failed",a);_classPrivateFieldGet(this,_cookies2).set(...a.headers.raw()["set-cookie"])})}async aquireBook(a){if(!_classPrivateFieldGet(this,_authenticated))throw new Error("Not authenticated");const b=await this._findBookInShelf(a),c=await this._ltiShelf(b);return await this._ltiCatalog(c),new _book.Book(a,Cookies.parse(_classPrivateFieldGet(this,_cookies2).toString()))}async authenticate(a,b){_classPrivateFieldSet(this,_cookies2,new Cookies);const c=await(0,_nodeFetch.default)("https://digi4school.at/br/xhr/login",{headers:{accept:"*/*","accept-language":"*","content-type":"application/x-www-form-urlencoded; charset=UTF-8"},body:`email=${encodeURIComponent(a)}&password=${encodeURIComponent(b)}`,method:"POST"});if(!c.ok)throw new _util.ResponseError("authentication failed",c);switch(await c.text()){case"OK":console.log("Login successful"),_classPrivateFieldSet(this,_authenticated,!0);break;case"KO":console.log("Login unsuccessful"),process.exit(-1);default:_classPrivateFieldSet(this,_authenticated,!0),console.warn("Login returned unexpected response, the login data either was bad or this tool is out of date. Continuing...");}_classPrivateFieldGet(this,_cookies2).set(...c.headers.raw()["set-cookie"])}}exports.User=User;