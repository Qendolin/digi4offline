"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.User=exports.Cookies=void 0;var _xmldom=require("xmldom"),_nodeFetch=_interopRequireDefault(require("node-fetch")),_book=require("./book.js"),_util=require("./util.js");function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}class Cookies{#cookies=new Map;static parse(a){const b=new Cookies;return a=a.replace(/^Cookie: /gi,""),b.set(...a.split("; ")),b}set(...a){a.forEach(a=>{const[b,c]=a.split(";",1)[0].split("=",2);this.#cookies.set(b,c)})}delete(a){const[b]=a.split(";",1)[0].split("=",2);this.#cookies.delete(b)}toString(){return[...this.#cookies.entries()].map(a=>`${a[0]}=${a[1]}`).join("; ")}}exports.Cookies=Cookies;class User{#cookies;#authenticated=!1;#domParser=new _xmldom.DOMParser;async _findBookInShelf(a){const b=await(0,_nodeFetch.default)(`https://digi4school.at/br/find/${a}/`,{headers:{cookie:this.#cookies.toString()}}).then(a=>{if(200!=a.status)throw new _util.ResponseError("failed to find book in bookshelf",a);return a.text()});return this._parseLtiResponse(b)}async _openBookFromShelf(a){const b=await(0,_nodeFetch.default)(a,{headers:{cookie:this.#cookies.toString()}}).then(a=>{if(200!=a.status)throw new _util.ResponseError("failed open book in shelf",a);return a.text()});return this._parseLtiResponse(b)}_parseLtiResponse(a){const b=this.#domParser.parseFromString(a,"text/html"),c=b.getElementsByTagName("form")[0],d=new URLSearchParams;return Array.from(c.getElementsByTagName("input")).forEach(a=>{d.set(a.getAttribute("name"),a.getAttribute("value"))}),[c.getAttribute("action"),d]}async _ltiShelf(a,b){const c=await(0,_nodeFetch.default)(a,{method:"POST",body:b.toString(),headers:{accept:"*/*","accept-language":"*",cookie:this.#cookies.toString(),"content-type":"application/x-www-form-urlencoded"},redirect:"manual"}).then(a=>{if(200!=a.status)throw new _util.ResponseError("lti failed",a);return this.#cookies.set(...a.headers.raw()["set-cookie"]),a.text()});return this._parseLtiResponse(c)}async _ltiLaunchRequest(a,b){return(0,_nodeFetch.default)(a,{method:"POST",body:b.toString(),headers:{accept:"*/*","accept-language":"*",cookie:this.#cookies.toString(),"content-type":"application/x-www-form-urlencoded"},redirect:"manual"}).then(a=>{if(302!=a.status)throw new _util.ResponseError("lti failed",a);const b=a.headers.get("location");if(!!b.match(/^https?:\/\/digi4school\.at\/err/))throw new Error(`lti returned error url: ${b}`);return this.#cookies.set(...a.headers.raw()["set-cookie"]),new URL(b)})}async aquireBook(a){if(!this.#authenticated)throw new Error("Not authenticated");let b=null,c=null;a.startsWith("http")?[b,c]=await this._openBookFromShelf(a):[b,c]=await this._findBookInShelf(a);const[d,e]=await this._ltiShelf(b,c),f=e.get("resource_link_id"),g=await this._ltiLaunchRequest(d,e),h=new _book.Book(f,g,Cookies.parse(this.#cookies.toString()));return await h.initialize(),h}_isUniqueBookId;async authenticate(a,b){this.#cookies=new Cookies;const c=await(0,_nodeFetch.default)("https://digi4school.at/br/xhr/login",{headers:{accept:"*/*","accept-language":"*","content-type":"application/x-www-form-urlencoded; charset=UTF-8"},body:`email=${encodeURIComponent(a)}&password=${encodeURIComponent(b)}`,method:"POST"});if(!c.ok)throw new _util.ResponseError("authentication failed",c);switch(await c.text()){case"OK":console.log("Login successful"),this.#authenticated=!0;break;case"KO":console.log("Login unsuccessful"),process.exit(-1);default:this.#authenticated=!0,console.warn("Login returned unexpected response, the login data either was bad or this tool is out of date. Continuing...")}this.#cookies.set(...c.headers.raw()["set-cookie"])}}exports.User=User;