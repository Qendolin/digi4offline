"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Book=void 0;var _util=require("./util.js"),_nodeFetch=_interopRequireWildcard(require("node-fetch")),_memoizee=_interopRequireDefault(require("memoizee")),_meta=require("./meta.js"),_xmldom=require("xmldom");function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _getRequireWildcardCache(a){if("function"!=typeof WeakMap)return null;var b=new WeakMap,c=new WeakMap;return(_getRequireWildcardCache=function(a){return a?c:b})(a)}function _interopRequireWildcard(b,c){if(!c&&b&&b.__esModule)return b;if(null===b||"object"!=typeof b&&"function"!=typeof b)return{default:b};var d=_getRequireWildcardCache(c);if(d&&d.has(b))return d.get(b);var e={__proto__:null},f=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var a in b)if("default"!=a&&Object.prototype.hasOwnProperty.call(b,a)){var g=f?Object.getOwnPropertyDescriptor(b,a):null;g&&(g.get||g.set)?Object.defineProperty(e,a,g):e[a]=b[a]}return e.default=b,d&&d.set(b,e),e}class Book{linkId;contentUrl;credentials;options;_initalized=0;_pageCount;_bookHtml;_pageUrlFormat=a=>`${a}/`;constructor(a,b,c,d){this.linkId=a,this.contentUrl=b,this.credentials=c,this.options={retryPage:10,retryImage:10,...d},this.init=(0,_memoizee.default)(this.initialize,{promise:!0}),this.info=(0,_memoizee.default)(this.info,{promise:!0}),this.pageCount=(0,_memoizee.default)(this.pageCount,{promise:!0}),this.page=(0,_memoizee.default)(this.page,{promise:!0}),this.resolveRanges=(0,_memoizee.default)(this.resolveRanges,{promise:!0}),this.image=(0,_memoizee.default)(this.image,{promise:!0})}async initialize(){if(0==this._initalized){this._initalized=1,this._bookHtml=await(0,_nodeFetch.default)(this.contentUrl,{headers:{accept:"*/*","accept-language":"*",cookie:this.credentials.toString()},method:"GET"}).then(a=>{if(!a.ok)throw new _util.ResponseError("failed to fetch book html",a);return a.text()});const a=this._bookHtml.match(/IDRViewer.makeNavBar\((\d+).*?(true|false)\)/);if(null==a)throw new Error(`Could not match init regex`);this._pageCount=parseInt(a[1]);const b="false"!=a[2];this._pageUrlFormat=b?await this._getIndirectPageUrlFormat():()=>"",this._initalized=2}}isInitialzed(){return 2==this._initalized}async _getIndirectPageUrlFormat(){const a=new URL("1.html",this.contentUrl).href,b=await(0,_nodeFetch.default)(a,{headers:{accept:"*/*","accept-language":"*",cookie:this.credentials.toString()},method:"GET"}).then(a=>{if(!a.ok)throw new _util.ResponseError("failed to fetch first page html",a);return a.text()}),c=new _xmldom.DOMParser().parseFromString(b,"text/html"),d=c.getElementById("jpedal");if(null==d)return console.warn("unexpected format: no jpedal found"),this._pageUrlFormat;const e=Array.from(d.getElementsByTagName("object"));if(0==e.length)return console.warn("unexpected format: no <object> found"),this._pageUrlFormat;const f=e[0].getAttribute("data");if(!f||!f.includes("1.svg"))return console.warn("unexpected format: no 1.svg found"),this._pageUrlFormat;const g=f.replace("1.svg","").split("1");return a=>g.join(a+"")}pageBaseUrl(a){return new URL(this._pageUrlFormat(a),this.contentUrl).href}async info(){return _meta.MetaInfoParser.parse(this._bookHtml)}pageCount(){if(!this.isInitialzed())throw new Error(`book is not initialized`);return this._pageCount}async page(a){const b=new URL(`${a}.svg`,this.pageBaseUrl(a)).href,c=await(0,_util.retryAsync)(this.options.retryPage,async()=>(0,_nodeFetch.default)(b,{headers:{accept:"*/*","accept-language":"*",cookie:this.credentials.toString()},method:"GET"}).then(a=>{if(!a.ok)throw new _util.ResponseError("failed to fetch page",a);return a.text()}).catch(a=>{if(!(a instanceof _nodeFetch.FetchError))throw a}));return c||""}async resolveRanges(a,b){var c=Math.min;const d=this.pageCount(),e=b?await this.info():null,f=a.reduce((f,{from:g,to:h},i)=>{let j,k;if(b?(j=e.labelPage(g),k=e.labelPage(h)):(j=+g,k=+h),isNaN(j)&&0!==i)throw new Error(`Range ${i+1} has invalid from`);if(isNaN(k)&&i!=a.length-1)throw new Error(`Range ${i+1} has invalid to`);return j=isNaN(j)?1:j,k=isNaN(k)?d:k,[...Array(k-j+1)].forEach((a,b)=>f.add(c(d,j+b))),f},new Set).values();return[...f]}async image(a,b){const c=new URL(b,this.pageBaseUrl(a)).href;return(0,_util.retryAsync)(this.options.retryImage,()=>(0,_nodeFetch.default)(c,{headers:{cookie:this.credentials.toString()}}).then(a=>{if(!a.ok)throw new _util.ResponseError("failed to download image",a);return a.buffer()}).catch(a=>{if(!(a instanceof _nodeFetch.FetchError))throw a}))}}exports.Book=Book;