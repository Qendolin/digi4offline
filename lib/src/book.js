"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Book=void 0;var _util=require("./util.js"),_nodeFetch=_interopRequireWildcard(require("node-fetch")),_xmldom=require("xmldom");function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var a=new WeakMap;return _getRequireWildcardCache=function(){return a},a}function _interopRequireWildcard(a){if(a&&a.__esModule)return a;if(null===a||"object"!=typeof a&&"function"!=typeof a)return{default:a};var b=_getRequireWildcardCache();if(b&&b.has(a))return b.get(a);var c={},d=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var e in a)if(Object.prototype.hasOwnProperty.call(a,e)){var f=d?Object.getOwnPropertyDescriptor(a,e):null;f&&(f.get||f.set)?Object.defineProperty(c,e,f):c[e]=a[e]}return c.default=a,b&&b.set(a,c),c}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}const metaInfoNames=["title","sbnr","publisher","publisherweb","publisheradr","publishertel","publishermail","pageLabels"];class Book{constructor(a,b,c){_defineProperty(this,"id",void 0),_defineProperty(this,"credentials",void 0),_defineProperty(this,"options",void 0),this.id=a,this.credentials=b,this.options={retryPage:10,retryImage:10,...c}}get url(){return`https://a.digi4school.at/ebook/${this.id}/`}async info(){const a=await(0,_nodeFetch.default)(`https://a.digi4school.at/ebook/${this.id}/`,{headers:{accept:"*/*","accept-language":"*",cookie:this.credentials.toString()},method:"GET"}).then(a=>{if(!a.ok)throw new _util.ResponseError("failed to fetch info",a);return a.text()}),b=new _xmldom.DOMParser().parseFromString(a,"text/html"),c=Array.from(b.documentElement.getElementsByTagName("meta")),d=Object.fromEntries(metaInfoNames.map(a=>[a,""]));for(const a of c){const b=a.getAttribute("name");metaInfoNames.includes(b)&&(d[b]=a.getAttribute("content"))}return d}async pageCount(){const a=await(0,_nodeFetch.default)(`https://a.digi4school.at/ebook/${this.id}/`,{headers:{cookie:this.credentials.toString()}}).then(a=>{if(!a.ok)throw new _util.ResponseError("failed to fetch page count",a);return a.text()});return parseInt(a.match(/IDRViewer.makeNavBar\((\d+)/)[1])}async page(a){const b=await(0,_util.retryAsync)(this.options.retryPage,async()=>(0,_nodeFetch.default)(`https://a.digi4school.at/ebook/${this.id}/${a}/${a}.svg`,{headers:{accept:"*/*","accept-language":"*",cookie:this.credentials.toString()},method:"GET"}).then(a=>{if(!a.ok)throw new _util.ResponseError("failed to fetch page",a);return a.text()}).catch(a=>{if(!(a instanceof _nodeFetch.FetchError))throw a}));return b||""}async resolveRanges(a){var b=Math.min;const c=await this.pageCount(),d=a.reduce((d,{from:e,to:f},g)=>{if(isNaN(e)&&0!==g)throw new Error(`Range ${g+1} has invalid from`);if(isNaN(f)&&g!=a.length-1)throw new Error(`Range ${g+1} has invalid to`);return e=isNaN(e)?1:e,f=isNaN(f)?c:f,[...Array(f-e+1)].forEach((a,f)=>d.add(b(c,e+f))),d},new Set).values();return[...d]}async image(a,b){const c=new URL(b,`${this.url}${a}/`).href;return(0,_util.retryAsync)(this.options.retryImage,()=>(0,_nodeFetch.default)(c,{headers:{cookie:this.credentials.toString()}}).then(a=>{if(!a.ok)throw new _util.ResponseError("failed to download image",a);return a.buffer()}).catch(a=>{if(!(a instanceof _nodeFetch.FetchError))throw a}))}}exports.Book=Book;