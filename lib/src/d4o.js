"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Digi4Offline=void 0;var _auth=require("./auth.js"),_download=require("./download.js"),_util=require("./util.js"),_wrapper=require("./worker/wrapper.js"),_path=_interopRequireDefault(require("path")),_fs=_interopRequireDefault(require("fs"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}class Digi4Offline{options;#user;constructor(a){this.options=a}login(a,b){return this.#user=new _auth.User,this.#user.authenticate(a,b)}async download(a,b,c){const d=await this.#user.aquireBook(a);d.options={...d.options,retryImage:this.options.imageRetries,retryPage:this.options.pageRetries};const e=new _download.RangeDownloader(this.options.dop,d),f=await d.resolveRanges(c,this.options.labels),g=await d.info();console.log("Title: %s\nSBNR: %s\nPublisher: %s\n\tURL: %s\n\tAddress: %s\n\tPhone Number: %s\n\tEmail Adress: %s",g.title,g.sbnr,g.publisher,g.publisherweb,g.publisheradr,g.publishertel,g.publishermail);const h=this._createPdf(b||"./",d.linkId,g,f),i=new _wrapper.Writer(h,g);i.on("write",({page:a,pageIndex:b})=>{console.log("Wrote page %s/%s %s",b+1,f.length,a)}),i.on("error",({message:a,args:b=[]})=>{console.error(a,...b)}),await e.download(f,({svg:a,images:b},{pageIndex:c,pageNr:d,downloadNr:e})=>{console.log("Downloaded page %s/%s %s",e,f.length,d),i.write(a,b.map,b.buffer,c,d)}),i.end(),console.log("Waiting for writer to fininsh..."),await i.done,console.log(h),i.worker.unref()}validateBookIdOrUrl(a){const b=!!a.match(/[^\d/]/),c=!!a.match(/^https?:\/\/digi4school\.at\/ebook\/[\da-z]{8,}$/g);return c||!b}_createPdf(a,b,c,d){let e=_path.default.basename(a),f=_path.default.dirname(a);(a.endsWith("/")||a.endsWith("\\")||!a)&&(e=["ebook",b.replace(/\//,"_"),c.sbnr?`sbnr_${c.sbnr}`:null,`p_${(0,_util.findRanges)(d)}`].filter(a=>!!a).join("-")+".pdf",f=a),_fs.default.mkdirSync(f,{recursive:!0});const g=_path.default.join(_path.default.resolve(f),e);return _fs.default.existsSync(g)&&_fs.default.truncateSync(g),g}}exports.Digi4Offline=Digi4Offline;