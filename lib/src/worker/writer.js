"use strict";var _worker_threads=require("worker_threads"),_pdfkit=_interopRequireDefault(require("pdfkit")),_fs=_interopRequireDefault(require("fs")),_svgToPdfkit=_interopRequireDefault(require("svg-to-pdfkit")),_xmldom=require("xmldom"),_canvas=_interopRequireDefault(require("canvas")),_nodeFetch=_interopRequireDefault(require("node-fetch")),_canvg=require("canvg"),_message=require("./message.js");function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}const brokenImageSrc="iVBORw0KGgoAAAANSUhEUgAAAA4AAAAQCAYAAAAmlE46AAABh0lEQVQoU42QSS9DURiGv7VfhKWEnyA2WFizsLciJGrowDVU55VIjE3sxFhB1ZDiVlUapYYguLRor9f5DrdRuaJv8izOOc+zORQIBFAKRFRGP+f3B6BlP/CYMecpo0NRFLBXFPt8fpzf6ThO50xJ3rzLkMduIfZ6vTi51hE5fZMYM85q6rUQ8tiXsdvtQfxKx3biFb/Hd0citNlsRXBDLpdbhmbbimcRiWu4uMvhXstL+D+4IadzDPFLHRvHL6aETzLYT2ZxcPZF6lYHNzQ66kQsnUdIfS4Jdrmh4eERqOKwdqiVBLuiIVKUIagXeaxEtQLL0UfMRKII7sSK7hnhckM0OKjgSISLew8ST2getePlqJuskDTPNWI2rBrvJFxuiByOARye57Gw+wDbklfIlYXIoH6yChObERIOCVc2ZLc7ZOhaDZpG31DDVDXNhRMcghuyWu1YT6TROF3zZ2TQEmxCNPUObqi/34q2hdZ/I+Oud60HvdY+UGdnF9rbO8ygHxS9dVss+AQqZY47NSC2iwAAAABJRU5ErkJggg==";class PageWriter{constructor(a){_defineProperty(this,"pages",[]),_defineProperty(this,"writerIndex",0),this.pdf=a}add(a,b,c,d,e){return this.pages[e]={svgSrc:a,imageBuffer:c,images:b,pageNr:d},this.wirteNext()}notifyWriteUpdate(a,b=this.writerIndex){_worker_threads.parentPort.postMessage(new _message.Message("write",{page:a,pageIndex:b-1}))}notifyError(a,...b){_worker_threads.parentPort.postMessage(new _message.Message("error",{message:a,args:b}))}async wirteNext(){const a=this.pages[this.writerIndex];if(null==a)return;this.pages[this.writerIndex]=null,this.writerIndex++;const{svgSrc:b,imageBuffer:c,images:d,pageNr:e}=a;if(this.pdf.addPage(),!b)return this.notifyWriteUpdate(e),this.wirteNext();try{(0,_svgToPdfkit.default)(this.pdf,b,0,0,{fontCallback:(a,b,c,d,...e)=>{console.log("Font Callback: %s %s %s %o .",a,b,c,d,...e)},imageCallback:a=>{if(!d.has(a))return console.error("Missing image on page %s: %s",e,a),`data:image/png;base64,${brokenImageSrc}`;const b=d.get(a);return c.slice(b.from,b.to)},documentCallback:(a,...b)=>(console.log("Document Callback: %o .",a,...b),a),warningCallback:(a,...b)=>{console.log("Warning Callback: %s .",a,...b)}})}catch(c){this.notifyError(`Failed to convert page #${this.writerIndex}:${a}, using png fallback, %s`,c);try{const a=await svg2img(b,909,1286);this.pdf.image(a,0,0,{fit:[909,1286]})}catch(b){this.notifyError(`Failed to convert page #${this.writerIndex}:${a} to png: %s`,b)}}return this.notifyWriteUpdate(e),this.wirteNext()}}const px2pt=72/96,pdf=new _pdfkit.default({size:[909*px2pt,1286*px2pt],autoFirstPage:!1,info:{Title:_worker_threads.workerData.info.title,Author:_worker_threads.workerData.info.publisher,Keywords:_worker_threads.workerData.info.sbnr}}),writer=new PageWriter(pdf),filestream=pdf.pipe(_fs.default.createWriteStream(_worker_threads.workerData.file));filestream.on("finish",()=>{_worker_threads.parentPort.postMessage(new _message.Message("done"))});let queue=Promise.resolve();_worker_threads.parentPort.on("message",a=>{switch(a.action){case"add":{const b=Buffer.from(a.data.svgBuffer).toString("utf-8"),c=Buffer.from(a.data.imageBuffer);queue=queue.then(()=>writer.add(b,a.data.images,c,a.data.page,a.data.pageIndex))}break;case"end":queue.then(()=>{pdf.end()});}});async function svg2img(a,b,c){const d=_canvg.presets.node({DOMParser:_xmldom.DOMParser,canvas:_canvas.default,fetch:_nodeFetch.default}),e=d.createCanvas(b,c),f=e.getContext("2d"),g=_canvg.Canvg.fromString(f,a,d);return await g.render(),e.toBuffer("image/png")}